---

- hosts: "all"
  become: True
  become_user: root
  vars_files:
    - 'variables.yml'

  tasks:
  - name: "Install libselinux-python on all servers"
    yum:
      name: "{{ packages }}"
      state: present
    vars:
      packages:
      - libselinux-python
  
  - name: "Install EPEL Release"
    package:
      name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
      
  - name: "Removing mariadb-libs"
    yum:
      name: 'mariadb-libs'
      state: absent

  - name: "Setting Selinux To Permissive"
    selinux:
      policy: targeted
      state: permissive

  - name: "Upgrading All Packages"
    yum:
      name: '*'
      state: latest

  - name: Installing Some Basic Packages
    yum:
      name: "{{ packages }}"
      state: present
    vars:
      packages:
      - wget
      - nano
      - pigz
      - socat
      - python2
      - python3
      - python2-pip
      - python3-pip

  - name: "Installing PyMySQL Module"
    pip:
      name: PyMySQL

- hosts: "xpand"
  become: True
  become_user: root
  vars_files:
    - 'variables.yml'
    - '/tmp/file_variables.yml'

  tasks:

  - name: "Download MariaDB ES Repo setup"
    get_url:
      url: "{{ mariadbrepo_url }}"
      dest: /tmp/mariadb_es_repo_setup
      mode: '0777'

  - name: "Set ES repo setup to executable"
    file:
      path: /tmp/mariadb_es_repo_setup
      owner: root
      group: root
      mode: 0755

  - name: "Install MariaDB ES Repo"
    shell: /tmp/mariadb_es_repo_setup --token={{ customer_token }} --apply --mariadb-server-version="10.5"
  - name: "Reloading Systemd"
    command: systemctl daemon-reload
  
  - name: "Install MariaDB Server"
    yum:
      name: mariadb-server
  - name: "Install MariaDB Xpand Plugin"
    yum:
      name: MariaDB-xpand-engine
      
- hosts: xpand
  become: True
  become_user: root
  vars_files:
    - '/tmp/file_variables.yml'

  tasks:

  - name: "Installing bzip2"
    yum:
      name: "{{ packages }}"
      state: present
    vars:
      packages:
      - bzip2
      - http://mirror.centos.org/centos/7/os/x86_64/Packages/libdwarf-tools-20130207-4.el7.x86_64.rpm

  - name: "Downloading Xpand"
    get_url:
      url: "{{ xpand_url }}"
      dest: /tmp/xpand.tar.bz2
      mode: '0777'

    
  - name: Uncompressing Xpand binaries
    command: tar xvf /tmp/xpand.tar.bz2 -C /tmp

  - name: "Startng Xpand"
    command: chdir=/tmp/{{ xpand_dir }} ./clxnode_install.py --yes
   
  - name: "Setting Xpand MYSQL Port"
    command: sed -i 's/#MYSQL_PORT=3306/MYSQL_PORT=4799/g' /etc/clustrix/clxnode.conf
    
